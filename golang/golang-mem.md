## Go的内存分配

[https://lihaoquan.me/2016/12/4/go-memory-alloc.html](https://lihaoquan.me/2016/12/4/go-memory-alloc.html)

*    计算机系统的主存被组织成一个由M个连续的字节大小的单元组成的数组，每个字节都有一个唯一的物理地址（PA）
*    现代处理器使用的是一种为虚拟寻址（VA）的寻址形式，最少的寻址单位是字
*    虚拟地址映射物理地址是通过读取页表（page table）进行地址翻译完成的：页表存放在物理存储器中
*   MMU（内核吧物理页作为内存管理的基本单位）以页（page）大小为单位来管理系统中的页表
*    在虚拟存储器的习惯说法中，DRAM缓存不命中的成为：缺页
*    page的结构与物理页相关，而非与虚拟页相关
*    系统中的每个物理页都要分配一个page结构体


动态存储分配器维护着一个进程的虚拟存储区域，这个区域称为 “堆”，堆可以视为一组大小不同的 “块”（chunk: 连续的虚拟存储片，无论内存分配器和垃圾回收算法都依赖连续地址）的集合，并交由动态存储器维护。

动态分配器主要分为：

    显式：常见的malloc
    隐式：垃圾回收

在Go里头，分配器将其管理（大块 --> 小块）的内存块分为两种：

    span：由多个连续的页（page）组成的大块内存
    object：将span按特定大小切分多个小块，每个小块可存储一个对象

按照其用途:

    span:面向内部管理
    object:面向对象分配

分配器按页数来区分不同大小的span。比如，以页数为单位将span存放到管理数组中，需要时就以页数为索引进行查找。当然，span大小并非固定不变。在获取闲置span时，如果没找到大小合适的，那就返回页数更多的，此时会引发裁剪操作，多余部分将构成新的span被放回管理数组。分配器还会尝试将地址相邻的空闲span合并，以构建更大的内存块，减少碎片，提供更灵活的分配策略。

Unix进程可以使用mmap函数来创建新的虚拟存储区域并将对象映射到这些区域中。mmap函数要求内核创建一个新的虚拟存储区域，最好是从起始地址start开始的一个区域，并将文件描述符fd指定的对象的一个连续的片（chunk）映射到新的区域。

---

* Go的内存分配器是采用google自家的tcmalloc，tcmalloc是一个带内存池的分配器，底层直接调用mmap函数，并使用bestfit进行动态分配。

* Go为每个系统线程分配了一个本地MCache,少量的地址分配就是从MCache分配的，并且定期进行垃圾回收，所以可见go的分配器包含了显式与隐式的调用。

* Go定义的小块内存，大小上是指32K或以下的对象，go底层会把这些小块内存按照指定规格（大约100种）进行切割：为了避免随意切割，申请任意字节内存时会向上取整到接近的块，将整块分配（从空闲链表）给到申请者。
  
Go内存分配主要组件：

* MCache：层次与MHeap类似，对于每个尺寸的类别都有一个空闲链表。每个M都有自己的局部Mcache(小对象从它取，无需加锁)，这就是Go能够在多线程中高效内存管理的重要原因

* MCentral：在无空闲内存的时候，向Mheap申请一个span,而不是多个，申请的span包含多少个page由central的sizeclass来确定（跨进程复用）

* MHeap：负责将MSpan组织和管理起来。
    * 分配过程：从free[]中分配，如果发生切割则将剩余的部分放回到free[]中
    * 回收过程：回收一个Mspan时，首选查找它相邻的地址，再通过map映射得到对应的Mspan，如果Mspan的state是未使用，则可以将 两者进行合并。最后将这页或者合并后的页归还到free[]分配池或者large中。

Go的内存模型可以视为两级的内存模型：

* 第一级：Mheap为主要组件：分配的单位是页，但管理的单位是MSpan,每次分配都是用bestFit的原则分配连续的页，回收是采用位图的方式。

* 第二级：MCache为主要组件：相当于一个内存池， 回收采用引用计数器
  
### 内存分配流程
    1、将小对象的大小向上取整到一个对应的尺寸类别（大约100种），查找相应的MCache的空闲链表，如果链表不空，直接从上面分配一个对象，这个过程不加锁

    2、如果MCache自由链表是空的，通过MCentral的自由链表取一些对象进行补充

    3、如果MCentral的自由链表是空的，则往MHeap中取用一些页对MCentral进行补充，然后将这些内存截断成特定规格

    4、如果MHeap空或者没有足够大的页的情况下，从操作系统分配一组新的页面，一般在1MB以上
